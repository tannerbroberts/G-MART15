name: Deploy Server to Heroku

# Trigger the workflow on push to main branch
on:
  push:
    branches:
      - main
    paths:
      - 'server/**'  # Only trigger when server files change

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # Check out the repository
      - uses: actions/checkout@v3

      # Set up Node.js environment
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'server/package-lock.json'

      # Install server dependencies
      - name: Install dependencies
        run: |
          cd server
          npm ci

      # Run server tests and deployment validation
      - name: Run tests and validate deployment
        run: |
          cd server
          npm test
          node ./tests/deployment-test.js

      # Deploy to Heroku
      - name: Deploy to Heroku
        uses: akhileshns/heroku-deploy@v3.12.13
        with:
          heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
          heroku_app_name: "gmart15-blackjack-express"  # Replace with your Heroku app name
          heroku_email: ${{ secrets.HEROKU_EMAIL }}
          appdir: "server"  # Specify the server directory for deployment